var http = require("http");
var transRules = require("../../config").TranspondRules;

module.exports = function () {
    this.transpond = function (req, res) {
        var transCurrent = transRules[req.headers.host.split(":")[0]];
        if (!transCurrent) {
            console.error('The transponding rules of "' + req.headers.host.split(":")[0] + '" is not defined, please check the config.js!');
            return false;
        }
        var options = {
            host: transCurrent.targetServer.host,
            port: transCurrent.targetServer.port || 80
        };
        options.headers = req.headers;
        options.path = req.url;
        options.method = req.method;
        //匹配regExpPath做特殊转发
        var i;

        for (i in transCurrent.regExpPath) {
            if (req.url.match(i)) {
                options.host = transCurrent.regExpPath[i].host || options.host;
                options.port = transCurrent.regExpPath[i].port || options.port;
                options.path = req.url.replace(i, transCurrent.regExpPath[i].path);
                if (transCurrent.regExpPath[i].attachHeaders) {
                    var j;
                    for (j in transCurrent.regExpPath[i].attachHeaders) {
                        options.headers[j] = transCurrent.regExpPath[i].attachHeaders[j];
                    }
                }
                break;
            }
        }

        var serverReq = http.request(options, function (serverRes) {
            //console.log(req.url + " " + serverRes.statusCode);
            res.writeHead(serverRes.statusCode, serverRes.headers);
            serverRes.on('data', function (chunk) {
                res.write(chunk);
            });
            serverRes.on('end', function () {
                res.end();
            });
        });

        serverReq.on('error', function (e) {
            console.error('problem with request: ' + e.message);
        });

        req.addListener('data', function (chunk) {
            serverReq.write(chunk);
        });

        req.addListener('end', function () {
            serverReq.end();
        });
    };
};